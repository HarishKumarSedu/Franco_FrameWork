from typing import Union, List, Optional

from cl_instr_lib.drivers.audio.apx.reusables import check_enum_or_str
from cl_instr_lib.drivers.audio.apx.bench.measurements.measurement import Measurement
from cl_instr_lib.drivers.audio.apx.enums import AcousticResponsePrimaryResults
from cl_instr_lib.drivers.audio.apx.bench.measurements.result.results_container.results_container import \
    AcousticResponseResultsContainer


class AcousticResponse(Measurement):
    """Base class for APx AcousticResponse Measurement, inherits from Measurement"""
    results: AcousticResponseResultsContainer

    def __init__(self, apx):
        self._apx = apx
        self.meas_name = 'AcousticResponse'
        self._primary_result_enum = AcousticResponsePrimaryResults
        super().__init__(apx)

    def add_result(self, result: Union[AcousticResponsePrimaryResults, str]):
        """
        Adds any valid acoustic response primary result graph

        :param result: Name of primary result to add. Options include:

            ACQUIRED_WAVEFORM, DELAY, DEVIATION, DISTORTION_PRODUCT_LEVEL, DISTORTION_PRODUCT_RATIO,
            ENERGY_TIME_CURVE, GROUP_DELAY, IMPULSE_RESPONSE, LEVEL_AND_DISTORTION, PHASE, RELATIVE_LEVEL,
            RMS_LEVEL, RUB_AND_BUZZ, RUB_AND_BUZZ_CREST_FACTOR, RUB_AND_BUZZ_PEAK_RATIO, THD_LEVEL, THD_RATIO

        :type result: AcousticResponsePrimaryResults | str
        """
        result = check_enum_or_str(f'{result}', result, AcousticResponsePrimaryResults)
        super().add_result(result.value)

    def configure_results(self, results: List[Union[AcousticResponsePrimaryResults, str]] = None) -> \
            Optional[List[Union[AcousticResponsePrimaryResults, str]]]:
        """
        Clears current results and configures the specified results in order. If no results are specified, returns the
        currently configured results. This only configures and returns primary results. If you want to configure
        derived results use the add_derived_result() method of the result object.

        :param results: Name of primary result to add. Options include:

            ACQUIRED_WAVEFORM, DELAY, DEVIATION, DISTORTION_PRODUCT_LEVEL, DISTORTION_PRODUCT_RATIO,
            ENERGY_TIME_CURVE, GROUP_DELAY, IMPULSE_RESPONSE, LEVEL_AND_DISTORTION, PHASE, RELATIVE_LEVEL,
            RMS_LEVEL, RUB_AND_BUZZ, RUB_AND_BUZZ_CREST_FACTOR, RUB_AND_BUZZ_PEAK_RATIO, THD_LEVEL, THD_RATIO

        :type results: List[AcousticResponsePrimaryResults | str]
        :return: list of currently configured results
        :rtype: List[AcousticResponseResults | str] | None
        """
        return super().configure_results(results)

    def get_result_options(self) -> List[str]:
        """
        Returns a list of AcousticResponsePrimaryResults enum string options that are valid for the add/configure
        results function

        :return: list of enum strings
        :rtype: List[str]
        """
        return [result.name for result in AcousticResponsePrimaryResults]

    def sync_with_gui(self):
        """
        Syncs the results for acoustic response with what is currently configured in the gui

        :return: None
        :rtype: None
        """
        self.results = AcousticResponseResultsContainer(self, self._query_current_results())
        self.update_pyi_file()
