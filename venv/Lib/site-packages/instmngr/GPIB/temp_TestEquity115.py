# -*- coding: utf-8 -*-
"""
Created on Mon Nov 28 11:23:13 2016

@author: jmunger
"""

import sys
from time import sleep
import logging

idnString = ' 4899A'  #actually the IDN of the 488 - Modbus controller accompanying the chamber

class Temp_TestEquity115():
    
    def __init__(self,rmHandle):
        self.rmHandle = rmHandle
        self.soakTimeSec = 120
        self.soakTimeElapsed = 0
        self.currentTempC = None
        self.setTempC = None
        self.numDec = 1  #number of decimal places required for commands
        self.stateList = ['IDLE','TRANSITION','SOAK','AT_TEMP']
        self.state = 'IDLE'
        self.logger = logging.getLogger('marv.inst.Temp_TestEquity115')
        self.logger.info('Initializing Temp_TestEquity115 instrument')
    
    def reset(self):
        # either power off supply & set to 0v output, or just execute *RST command
        self.rmHandle.write('*RST')
        self.numDec = int(self.rmHandle.query('R? 606,1').strip())       
        pass
    
    def setSoakTimeSec(self,soaktime=120):
        self.soakTimeSec = soaktime
        
    def getCurrentTemp(self):
        self.currentTempC = float(self.rmHandle.query('R? 100,1').strip()) / (10 ** self.numDec)
        return self.currentTempC
            
    def setTemp(self,setTempC=25.0):
        self.setTempC = setTempC
        cmdStr = 'W300,' + str(int(setTempC * (10 ** self.numDec)))
        cmdResult = self.rmHandle.write(cmdStr)
        self.evalTempState()
        #later, add error checking here & return success or error code
        
    def evalTempState(self,marginC=0.5):
        self.getCurrentTemp()
        tempDelta = abs(self.currentTempC - self.setTempC)
        if self.state == 'IDLE':
            if tempDelta > marginC:
                self.state = 'TRANSITION'
                self.logger.info( 'Temp Transition Begin')
        elif self.state == 'TRANSITION':
            if tempDelta < marginC:
                self.state = 'SOAK'
                self.logger.info('Temp  Soak Begin')
        elif self.state == 'SOAK':
            if self.soakTimeElapsed == self.soakTimeSec:
                self.state = 'AT_TEMP'
                self.soakTimeElapsed = 0
                self.logger.info( 'Temp  Soak End')
        elif self.state == 'AT_TEMP':
            if tempDelta > marginC:
                self.state = 'TRANSITION'
                self.logger.info('Temp Transition Begin')
            
            
        
    def waitTempTransition(self,marginC=0.5):
        timerTick = 1 #second
        while self.state == 'TRANSITION':
            self.logger.info( 'Temp transition: set ' + str(self.setTempC) + ' current ' + str(self.currentTempC))
            sleep(5)            
            self.evalTempState(marginC=marginC)
        while self.state == 'SOAK':
            sleep(timerTick)
            self.soakTimeElapsed = self.soakTimeElapsed + timerTick
            self.evalTempState(marginC=marginC)
        self.logger.info( 'At Temperature: set ' + str(self.setTempC) + ' current ' + str(self.currentTempC))
                
        
    def getIdn(self):
        return self.rmHandle.query('*IDN?')
        
    def close(self):
        #here, might need to communicate with instrument manager to retire the instance listed there
        self.rmHandle.close()
        pass
    
    
    
if __name__ == "__main__":
    import os,sys
    mgrRootDir = os.path.abspath(os.path.join(os.path.dirname(sys.argv[0]),'..'))
    sys.path.append(mgrRootDir)

    import InstMgr
    instMgr = InstMgr.InstMgr()
    mi = instMgr.checkout(interface='GPIB',addr=4,moduleSuffix=' 4899A')
    mi.reset()
    print(mi.getIdn())
    
    print(str(mi.getCurrentTemp()))
    mi.setSoakTimeSec(15)
    mi.setTemp(30.5)
    mi.setTemp(35.1)
    mi.waitTempTransition(marginC=3)
    mi.setTemp(25)
    mi.waitTempTransition(marginC=1)
    

    
    
    mi.close()
    pass    