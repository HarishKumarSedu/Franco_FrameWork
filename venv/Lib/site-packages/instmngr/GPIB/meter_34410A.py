# -*- coding: utf-8 -*-
"""
Created on 10 Aug 2018 

@author: dzhang
"""

import sys
import logging

idnString = '34410A'


class Meter_34410A():

    instDict = {'DCV': {'range':[0.1,(0.1,1000),'VOLT:DC:RANG'],
                        'autorange':['ON',{'on':'ON','off':'OFF'},'VOLT:DC:RANG:AUTO'],
                        'resolution':[1e-3,None,'VOLT:DC:RES'],
                        'numPLCycles':[1,(0.006,100),'VOLT:DC:NPLC'],
                        # 34410A doesn't seem to have digital filter functions
                        #'analogFilt':['OFF',{'on':'ON','off':'OFF'},'VOLT:DC:FILT'],
                        #'digitalAveFilt':['OFF',{'on':'ON','off':'OFF'},'VOLT:DC:FILT:DIG']
                        },
                'ACV': {'range':[0.1,(0.1,1000),'VOLT:AC:RANG'],
                        'autorange':['ON',{'on':'ON','off':'OFF'},'VOLT:AC:RANG:AUTO']},
                'DCI': {'range':[1e-3,(1e-4,3),'CURR:DC:RANG'],
                        'autorange':['ON',{'on':'ON','off':'OFF'},'CURR:DC:RANG:AUTO']},
                'ACI': {'range':[1e-3,(1e-4,3),'CURR:AC:RANG'],
                        'autorange':['ON',{'on':'ON','off':'OFF'},'CURR:AC:RANG:AUTO']},
                'RES': {'range':[1e5, (100, 1e9),'RES:RANG'],
                        'autorange':['ON',{'on':'ON','off':'OFF'},'RES:RANG:AUTO']},
                'FREQ': {'range':[10,(0.1, 1000),'FREQ:VOLT:RANG'],
                         'autorange':['ON',{'on':'ON','off':'OFF'},'FREQ:VOLT:AUTO']},
                'measType': ['"VOLT:DC"',{'DCV':'"VOLT:DC"','ACV':'"VOLT:AC"','DCI':'"CURR:DC"','ACI':'"CURR:AC"','RES':'"RES"','FREQ':'"FREQ"'},'FUNC '],
                'trigger': {'source':['IMM',{'bus':'BUS','immediate':'IMM','external':'EXT', 'internal':'INT'},'TRIG:SOUR'],
                            'delaySec':[0,(0,3600),'TRIG:DEL'],
                            'autodelay':['OFF',{'on':'ON','off':'OFF'},'TRIG:DEL:AUTO'],
                            'samplesPerTrigger':[1,(1,50000),'SAMP:COUN'],
                            'triggerCount':[1,(1,50000),'TRIG:COUN'],
                            }
    }


    def __init__(self,rmHandle):
        self.rmHandle = rmHandle
        self.logger = logging.getLogger('marv.inst.Meter_34410A')
        self.logger.info('Initializing Meter_34410A instrument')
    
    def reset(self):
        self.rmHandle.write('*RST')        
        pass
    
    def setMeas(self,measType='DCV'):
        if measType in self.instDict['measType'][1].keys():
            self.instDict['measType'][0] = self.instDict['measType'][1][measType]
            self.rmHandle.write(self.instDict['measType'][2] + self.instDict['measType'][0])
        else:
            self.logger.warning('WARNING - requested measurement type not known to instrument class')
            
    def setTrigParam(self,param='source',val='immediate'):
        self.setMeasParam(measType='trigger',param=param,val=val)
    
    def setMeasParam(self,measType='DCV',param='range',val=1e-3):
        inputValid = 0
        if param in self.instDict[measType].keys():
            if isinstance(self.instDict[measType][param][0],str):
                if val in self.instDict[measType][param][1].keys():
                    self.instDict[measType][param][0] = self.instDict[measType][param][1][val]
                    inputValid = 1
                else:
                    self.logger.warning('WARNING - requested discrete value not known to instrument class.  Valid options are ' + ','.join(self.instDict[measType][param][1].keys()))
#                    print('error - requested discrete value not known to instrument class.  Valid options are ' + ','.join(self.instDict[measType][param][1].keys()))
            else:
                if (self.instDict[measType][param][1] is None ) or ((self.instDict[measType][param][1] is not None) and (val >= self.instDict[measType][param][1][0] ) and (val <= self.instDict[measType][param][1][1] ) ):
                    self.instDict[measType][param][0] = val
                    inputValid = 1
        else:
            self.logger.warning('WARNING - requested measurement type not known to instrument class')
#            print('error- requested parameter not known to instrument class')
        
        if inputValid == 1:
            self.rmHandle.write(self.instDict[measType][param][2] + ' ' + str(self.instDict[measType][param][0]))
            
    def getMeas(self):
        retval = self.rmHandle.query('read?')
        return float(retval)

    def getIdn(self):
        return self.rmHandle.query('*IDN?')
    
    def selftest(self):
        return self.rmHandle.query('*TST?')
        
    def close(self):
        #here, might need to communicate with instrument manager to retire the instance listed there
        self.rmHandle.close()
        pass
    
    
    
if __name__ == "__main__":
    import os,sys
    mgrRootDir = os.path.abspath(os.path.join(os.path.dirname(sys.argv[0]),'..'))
    sys.path.append(mgrRootDir)

    import InstMgr
    instMgr = InstMgr.InstMgr()
    dmm = instMgr.checkout(objName='dmm1', interface='GPIB',addr=16,moduleSuffix='34410A')
    dmm.reset()
    print(dmm.getIdn())

    dmm.setMeasParam('DCV', 'autorange', 'on')
    print(dmm.getMeas())
    
    dmm.close()
    pass    