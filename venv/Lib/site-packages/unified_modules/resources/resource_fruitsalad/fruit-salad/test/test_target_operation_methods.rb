################################################################################
### Copyright (c) 2016-2017 Cirrus Logic International (UK) Ltd. All rights reserved.
###
### This software as well as any related documentation is furnished under
### license and may only be used or copied in accordance with the terms of the
### license. The information in this file is furnished for informational use
### only, is subject to change without notice, and should not be construed as
### a commitment by Cirrus Logic International (UK) Ltd. Cirrus Logic
### International(UK) Ltd assumes no responsibility or liability for any errors
### or inaccuracies that may appear in this document or any software that may be
### provided in association with this document.
###
### Except as permitted by such license, no part of this document may be
### reproduced, stored in a retrieval system, or transmitted in any form or by
### any means without the express written consent of Cirrus Logic International
### (UK) Ltd or affiliated companies.
###
### @file   test_target_operation_methods.rb
### @brief  Tests of target operations test method definitions.
###
### @warning
###   This software is specifically written for Cirrus Logic devices.
###   It may not be used with other devices.
################################################################################

# ensure that the gem version of test-unit is loaded
# otherwise the report generation will not occur.
gem 'test-unit'
require 'test/unit'

require_relative '../src/fruitsalad_env_setup.rb'
require_relative '../src/test_method_definitions/target_operations.rb'

require 'configuration'
require 'fruitsalad_utils'

if __FILE__ == $0
    raise 'IP address not specified as argument' if ARGV.size < 1
end

# When test is executed individually with ip address as argument.
unless ARGV[0] =~ /.rb/
    $arg = ARGV[0]
# When test is invoked through rake file with ip address as argument.
else
    exit unless ENV['TARGET'] =~ /remote/i
    $arg = ENV['IP']
end

#######################################################################
# Class: TestTargetOperationMethods
#
# Test case for testing target operations test method definitions.
#
#######################################################################
class TestTargetOperationMethods < Test::Unit::TestCase

    ###########################################################################
    #
    # @function create_remote_salad
    #
    # Creates an instance of RemoteSalad with a given configuration.
    #
    # @param [String] config  Path to a configuration file.
    # @param [String] user    Remote user name.
    # @param [String] address IP address of a remote system.
    #
    # @return [RemoteSalad] An instance of RemoteSalad.
    #
    ###########################################################################
    def create_remote_salad( config, user, address )
        Conf.set_source( config )
        Conf.set( :Remote_User, user )
        Conf.set( :Remote_Address, address )
        # has to be required _after_ loading configuration
        require 'src/targets/RemoteSalad'
        device = FruitSalad::get_device()
        raise 'Device not connected.' unless device.device_connected?
        return device
    end

    #######################################################################
    # @function test_target_operation_methods
    #
    # Testing test_target_operation_methods method:
    #
    # (no parameters)
    #
    #######################################################################
    def test_target_operation_methods
        ip_address = $arg
        device = create_remote_salad( 'configs/cirruslink_linux.yaml',
                                      'root',
                                      ip_address
                                    )

        assert_nothing_raised do
            connect_to_target()
        end

        codec_name = Conf.property( :CodecName, 'moon' )        # Get the codec name
        usecase_path = Conf.property( :UsecasePath, 'targets/arndale_linux_usecases/' )
        usecase_path = File.join( ENV['FRUITSALAD_HOME'], "#{usecase_path}#{codec_name}" )
        destination_path = Conf.property( :Remote_TempDir, '/tmp/fruitsalad/' )

        # Copy the binary file to run on target platform
        bin_file = Conf.property( :SaladMix_Binary, 'arm-linux-gnueabihf-saladmix' )
        bin_file_path = File.join( ENV['FRUITSALAD_HOME'], 'bin/' )
        is_executable = true
        saladmix_binary = true

        assert_nothing_raised do
            copy_file( destination_path,
                       bin_file_path,
                       bin_file,
                       is_executable,
                       saladmix_binary
                     )
        end

        # load the SCC usecase file into target platform
        usecase_file = Conf.property( :Reset_All, nil )
        assert_nothing_raised do
            load_routing_file( destination_path, usecase_path, usecase_file )
        end
    end

    #######################################################################
    #
    # @function test_enrolment_loading_and_unloading
    #
    # Testing loading and unloading of scc enrollment.
    #
    # (no parameters)
    #
    #######################################################################
    def test_enrolment_loading_and_unloading
        ip_address = $arg
        device = create_remote_salad( 'configs/cirruslink_linux.yaml',
                                      'root',
                                      ip_address
                                    )
        device.setup

        codec_name = Conf.property( :CodecName, 'moon' )
        usecase_path = Conf.property( :UsecasePath, 'targets/arndale_linux_usecases/' )
        src_bin_path = File.join( ENV['FRUITSALAD_HOME'], "#{usecase_path}#{codec_name}/" )
        destination_path = Conf.property( :Remote_LibFirmware, '/lib/firmware/' )

        # Copy the binary file to run on target platform
        bin_file = 'okgoogle.bin'
        is_executable = false
        saladmix_binary = false
        is_enrollment = true
        assert_nothing_raised do
            copy_file( destination_path,
                       src_bin_path,
                       bin_file,
                       is_executable,
                       saladmix_binary,
                       is_enrollment:is_enrollment
                     )
        end

        bin_file = 'moon-dsp6-ctrl.bin'
        assert_nothing_raised do
            remove_file( bin_file, destination_path )
        end

        bin_file = 'multi_trigger_phrase.bin'
        is_enrollment = true
        assert_nothing_raised do
            copy_file( destination_path,
                       src_bin_path,
                       bin_file,
                       is_executable,
                       saladmix_binary,
                       is_enrollment:is_enrollment
                     )
        end

        bin_file = 'moon-dsp6-ctrl.bin'
        assert_nothing_raised do
            remove_file( bin_file, destination_path )
        end

    end
end
################################### END OF FILE ###########################
