################################################################################
###
### Copyright (c) 2014 Wolfson Microelectronics plc.  All rights reserved.
###
### This software as well as any related documentation is furnished under
### license and may only be used or copied in accordance with the terms of the
### license. The information in this file is furnished for informational use
### only, is subject to change without notice, and should not be construed as
### a commitment by Wolfson Microelectronics plc. Wolfson Microelectronics plc
### assumes no responsibility or liability for any errors or inaccuracies that
### may appear in this document or any software that may be provided in
### association with this document.
###
### Except as permitted by such license, no part of this document may be
### reproduced, stored in a retrieval system, or transmitted in any form or by
### any means without the express written consent of Wolfson Microelectronics plc.
###
### @file device_factory.rb
### @brief Factory methods to instantiate FruitSalad device.
###
### @version \$Id: device_factory.rb 365 2014-11-05 15:03:24Z aangus $
###
### Warning
###   This software is specifically written for Wolfson devices. It may not be
###   used with other devices.
###
#################################################################################

#################################################################################
#
# Encapsulates singleton functionality of FruitSalad interfaces. Intended to be
# included in a platform-specific FruitSalad module specialisation as a mix-in.
#
#################################################################################
module FruitSaladDeviceFactory

    #############################################################################
    #
    # Used to store the runtime-type of the specialised FruitSalad device to be
    # instantiated on this run. This should be set after the platform specific
    # FruitSalad Device is defined.
    #
    # e.g. "device_type = NullSalad" in null/fruitsalad.rb
    #
    #############################################################################
    @@device_type = nil

    #############################################################################
    #
    # Module attribute to store the singleton FruitSalad device once it has been
    # created.
    #
    #############################################################################
    @@default_device = nil

    #############################################################################
    #
    # Set the type of FruitSalad device to be instantiated by the first call to
    # get_device().
    #
    # @param device_type The type name of a specialisation of the
    #                    FruitSaladInterface.
    #
    #############################################################################
    def type=( device_type )
        @@device_type = device_type
    end

    #############################################################################
    #
    # Set the type of FruitSalad device to nil
    #
    #############################################################################
    def set_device_nil()
        @@default_device = nil
    end

    #############################################################################
    #
    # Return a global FruitSalad device according to the type set using type=
    #
    # The first time it is called it instantiates a FruitSalad device and assigns
    # it to the @@default_device module attribute before returning the object.
    #
    # Subsequent calls are idempotent and return the device stored in
    # @@default_device by the first call.
    #
    # @return A default, singleton, FruitSalad test fixture.
    #
    # @raise [NoMethodError] If your FruitSalad specialisation does not call
    #                        type= to register itself as the active
    #                        specialisation.
    #
    #############################################################################
    def get_device()
        if nil == @@default_device
            @@default_device = @@device_type.new
        end
        @@default_device
    end
end

############################### END OF FILE #####################################