# @title Setting Raspberry Pi up for testing
<!--============================================================================
==
== Copyright (c) 2015 Cirrus Logic International (UK) Ltd.  All rights reserved.
==
== This software as well as any related documentation is furnished under
== license and may only be used or copied in accordance with the terms of the
== license. The information in this file is furnished for informational use
== only, is subject to change without notice, and should not be construed as
== a commitment by Cirrus Logic International (UK) Ltd.  Cirrus Logic International
== (UK) Ltd assumes no responsibility or liability for any errors or inaccuracies
== that may appear in this document or any software that may be provided in
== association with this document.
==
== Except as permitted by such license, no part of this document may be
== reproduced, stored in a retrieval system, or transmitted in any form or by
== any means without the express written consent of Cirrus Logic International
== (UK) Ltd or affiliated companies.
==
== @file    RaspberryPiTesting.md
== @brief   How to on setting up Raspberry Pi as a test target.
==
== @version \$Id: RaspberryPiTesting.md 961 2015-03-18 14:54:29Z piotrs $
==
== @warning
==   This software is specifically written for Cirrus Logic devices.
==   It may not be used with other devices.
==
=============================================================================-->

Setting Raspberry Pi up for testing
===================================

Introduction
------------

This document contains instructions on setting up a Raspberry Pi as a target
for FruitSalad testing. Raspberry Pi tests can be ran in two ways, locally
or remotely. To execute tests locally you will need a full installation of
FruitSalad on the device. This is not necessary when targeting a Pi as a remote
device. However, in both cases FruitSalad requires several binaries to be built
and installed on the Pi.

Set up for local execution
--------------------------

To run tests locally you will need to:

1. Copy a FruitSalad release onto your Raspberry Pi.
2. Install ruby and required dependencies (instructions on this subject can be
   found in `<FruitSaladRoot>/linux.txt`).
3. Build tinyalsa binaries distributed along with FruitSalad.

        cd <FruitSaladRoot>/vendor/tinyalsa
        make
        sudo cp tinycap tinymix tinypcminfo tinyplay /usr/local/bin
        sudo cp libtinyalsa.so /usr/local/lib

4. Build saladmix.

        cd <FruitSaladRoot>/src/extensions/saladmix
        make
        sudo make install INSTALL_DIR=/usr/local/bin
        make clean

5. You might also have to add the directory containing libtinyalsa.so
   to LD_LIBRARY_PATH.

        echo 'export LD_LIBRARY_PATH=/usr/local/bin:$LD_LIBRARY_PATH' > ~/.bashrc
        source ~/.bashrc

Set up for remote execution
---------------------------

If you want to run tests remotely you can either go through the steps above,
or you may want to cross-compile the required binaries on your PC and copy them
over to your PI. The Pi will also have to be configured to accept SSH
connections.

Before trying to cross-compile the binaries make sure you have added the
cross-compiler you want to use to `PATH`. And execute the following:

1. to build tinyalsa binaries:

        cd <FruitSaladRoot>/vendor/tinyalsa
        make CROSS_COMPILE=<cross-compiler prefix>

2. to build saladmix:

        cd <FruitSaladRoot>/src/extensions/saladmix
        make CROSS_COMPILE=<cross-compiler prefix>

Then copy the resulting binaries and libraries to appropriate locations on your
Pi (for instance /usr/local/bin and /usr/local/lib respectively). You will
notice that the saladmix binary built this way will be named - `<cross-compiler
prefix>-saladmix`, it's worth renaming this to just `saladmix` once it is copied
over to your Pi.

More information on remote testing can be found [here](file.LinuxRemote.html).

Configuring FruitSalad
----------------------

When running tests on a Raspberry Pi you may need to set several options in
`<your configuration>.yaml`, specifically:

1. `Linux_AudioCardIndex: <index of your audio card>` - defaults to 0.
2. `SaladMix_Location: <path to saladmix executble>` - this option instructs
   FruitSalad to use saladmix to set up routes on the device (load use cases).
   It defaults to nil in which case shell scripts will be used. If you have
   set up your Pi in accordance with this how to set this option to `saladmix`.
3. `DefaultUsecases: <array of default usecase names (without file extension)>` -
   defaults to `[ 'Playback_from_Headset', 'Record_from_Headset' ]`.
4. `UsecasePath: <path pointing to a directory containing *.csv usecase files>` -
   defaults to `targets/pi_usecases`.
5. `Saladmix_Upload: <true/false>` - defaults to false. This option is specific
   to the remote target. If it's set to true the executable located at
   `SaladMix_Location` will be uploaded to a temporary location and used. Note
   that if you set this option to false (or do not provide it) but provide
   a `SaladMix_Location` when executing a remote test, the `SaladMix_Location`
   will be treated as a location on the remote system.
