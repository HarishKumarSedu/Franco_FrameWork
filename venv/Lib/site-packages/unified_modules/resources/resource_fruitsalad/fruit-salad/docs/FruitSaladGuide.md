# @title Cirrus Fruit Salad
<!--============================================================================
==
== Copyright (c) 2014-2015 Cirrus Logic International (UK) Ltd.  All rights reserved.
==
== This software as well as any related documentation is furnished under 
== license and may only be used or copied in accordance with the terms of the 
== license. The information in this file is furnished for informational use 
== only, is subject to change without notice, and should not be construed as 
== a commitment by Cirrus Logic International (UK) Ltd.  Cirrus Logic International
== (UK) Ltd assumes no responsibility or liability for any errors or inaccuracies
== that may appear in this document or any software that may be provided in
== association with this document. 
==
== Except as permitted by such license, no part of this document may be 
== reproduced, stored in a retrieval system, or transmitted in any form or by 
== any means without the express written consent of Cirrus Logic International
== (UK) Ltd or affiliated companies. 
==
== @file    FruitSaladGuide.md
== @brief   Markdown documentation file for generating html help pages with yard.
==
== @version \$Id: FruitSaladGuide.md 1012 2015-04-27 14:07:30Z emmas $
==
== @warning
==   This software is specifically written for Cirrus Logic devices.
==   It may not be used with other devices.
==
=============================================================================-->

Welcome to Cirrus Fruit Salad (V1.0.15.0.-1)
=============================

Introduction
------------

Fruit Salad is an automated acceptance test system for Cirrus hardware, 
allowing tests to be specified in plain English and to be tested based on 
that same specification.

At its core Fruit Salad runs the Behaviour-Driven Development (BDD) tool cucumber (see [cukes.info](http://cukes.info))
which allows expected behaviours to be written in a plain text feature files that can be run
to verify whether or not a product passes a given specification.

It is the intention of Fruit Salad that a single specification can be used to verify a device or software
component throughout its lifecycle regardless of the underlying platform on which it is being tested.

_Fruit Salad is currently under development, so this documentation will be 
expanded as the project develops._

The following topics provide guidance for using Fruit Salad:

* [Installation](#Installation) 
* [Usage](#Usage) 
* [Extending](#Extending_Fruit_Salad)
* [Trouble-Shooting FAQ](#Trouble-shooting_FAQ)

See also the [Glossary](file.glossary.html).

Installation
============

Fruit Salad is provided as a compressed archive or installer which extracts the framework home directory.

The files `linux.txt` and  `windows.txt`, found in the root of the installation directory, contain instructions for setting up Fruit Salad on these two environments. 

The following are pre-requisites for installing the Fruit Salad system:

* Ruby (see [Ruby download](https://www.ruby-lang.org/en/downloads/))
    * Current development is using Ruby 1.9.3 (p545).
    * For Windows systems, install the Dev Kit to build native gems; download [here](http://rubyinstaller.org/downloads), setup instructions [here](https://github.com/oneclick/rubyinstaller/wiki/Development-Kit).
    <br>
    **Note**: Ruby and the Dev Kit should be installed to a location without spaces in the file path.
* gem (if not installed with Ruby, see https://rubygems.org/pages/download)
* bundle (at the command line, type `gem install bundle`. Then, from the Fruit Salad folder, at the command line, type `bundle install` to install all other dependencies).
<br>
**Note**: you may need to update your Ruby certificate authorities file - see https://gist.github.com/fnichol/867550

Standalone Executable
---------------------

On the Windows platform there is also a standalone executable (`fruitsalad.exe`) that packages a Ruby interpreter along with all of the dependent source code, gems and DLLs specific to the Fruit Salad project. This avoids the need to install a Ruby environment and users of the pre-built application should replace the Ruby commands with calls to this executable, i.e.:

    >ruby fruitsalad.rb --help

becomes

    >fruitsalad.exe --help

Running FruitSalad
------------------

To see the initial help information, run the following command:

    >ruby fruitsalad.rb --help

To run an example feature:

    >ruby fruitsalad.rb null -f example_features\tone_generation.feature

This will run for the null target platform which does no actual playback/record and instead only copies test files for quick API testing.

The -f argument allows the specification of a particular feature file or directory to be queued for testing (otherwise Fruit Salad will look for and queue all feature files located under the current working directory).

Tone generation will create an audio file of a given frequency and play this back using the specified platform (in the null case, a file copy). The recorded output is then analysed and checked according to the specifications of the feature file. As the feature file executes, the details of the scenarios being tested will be output to the console, followed by a testing summary that should look something like:

    > 3 scenarios (3 passed)
    > 12 steps (12 passed)
    > 0m2.157s


Folder Structure
----------------

Fruit Salad installs to a folder structure which includes the following subfolders:

  `configs` &mdash; default configuration files. `default_conf.yaml` is loaded by default each time Fruit Salad is run.

  `docs` &mdash; generated documentation on the current API implementation.

  `lib` &mdash; shared library binaries for interacting with various platforms.

  `targets` &mdash; hardware-specific set up. See [UseCase Files](#UseCase_Files) for details of these files.

  `features` &mdash; for defining functionality such as playback or recording. See [Features Files](#Features_Files)  for details of these files.

  `resources` &mdash; common resources files such as test waveforms or expected responses.

  `src` &mdash; underlying Ruby scripts and buildable extension source.

  `tools` &mdash; support tools for working with specific platforms.



### UseCase Files

The `*_usecases` folders contain CSV files for setting up hardware. 
Written for TinyMix, these are turned into shell scripts and executed. 

To obtain a marked speed increase (by performing block, rather than individual, writes of mixer properties), compile `__saladmix__` (in subfolder `saladmix`) using either the Android NDK or gcc (for Linux).


### Features Files

The `features` folder contains `.feature` files which each define a single or a collection of related functionality, such as playback or recording. Within each `.feature` file are the following statements:

* *Background* &mdash; optionally one per feature; defines preconditions common to all scenarios, such as being connected to a device 
<br><br>
* *Scenario* &mdash; optional; defines tests. Within each scenario are the following statements:
    <br><br>
    - `Given <pre-condition>`
    - `When <transition or event to be tested>`
    - `Then <post-condition>`
    <br><br>
    
    For all three statements, multiple statements can be concatenated using the keywords `and` or `but`.
    
    The `<texts>` used in the above statements are defined in step definitions, found in the `step_definitions` sub-folder. These convert the statement into Ruby code, and are specified as:
    
        <text> do
            ..Ruby code..
        end

Usage
=====

A Fruit Salad test suite is run on the command line as follows:

    ruby fruitsalad.rb remote -c <config_file> -a <address>
    
where:
   
   `fruitsalad.rb` - the Fruit Salad command
   
   `remote` - use ethernet connection (i.e. not a standalone or a native system)
   
   `config_file` - configuration file, in YAML
   
   `address` - connection address, specified as <user name>:<host name>
    
On running the suite remotely, Fruit Salad requires either a private key to be present on the system, or it will prompt for login information.
The hardware will then be configured (see [UseCase Files](#UseCase_Files)) and the test suite run.

Fruit Salad is intended to be used within the directory structure of the project under test. See [here](file.ProjectUsage.html) for guidelines
on setting up and running Fruit Salad from outside of the home directory.

**Note** that, when specifying paths in Config files on Windows, the '/' character should be used in place of '\' due to the way Ruby stores filepaths internally e.g. `TempDir: "C:/fruitsalad_tmp/"` 

Extending Fruit Salad
=====================

To use Fruit Salad, the [Fruit Salad API](../yard/frames.html) is available.

Trouble-shooting FAQ
====================

Error: "cannot load such file -- ffi_c (Load Error)"
Possible cause: FruitSalad is written to run against Ruby 1.9.3. Verify that you are using Ruby 1.9.3 using 'ruby --version'.

Error: "Gem::RemoteFetcher::FetchError: SSL_connect returned=1 errno=0 state=SSLv3 read server certificate B: certificate verify failed (https://rubygems.org/gems/rake-10.4.0.gem)"
Possible cause: Due to an upstream issue rubygems.org were forced to change the body issuing their security certificate. Until the patch is merged upstream: the first time you run 'bundle install' you must first edit 'Gemfile' in the FruitSalad directory and change the address 'https://rubygems.org' to 'http://rubygems.org'. It is recommended that you change it back after bundle has run successfully.
