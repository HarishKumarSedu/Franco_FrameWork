###############################################################################
###
### Copyright (c) 2015 Cirrus Logic International (UK) Ltd.  All rights reserved.
###
### This software as well as any related documentation is furnished under 
### license and may only be used or copied in accordance with the terms of the 
### license. The information in this file is furnished for informational use 
### only, is subject to change without notice, and should not be construed as 
### a commitment by Cirrus Logic International (UK) Ltd.  Cirrus Logic International
### (UK) Ltd assumes no responsibility or liability for any errors or inaccuracies
### that may appear in this document or any software that may be provided in
### association with this document. 
###
### Except as permitted by such license, no part of this document may be 
### reproduced, stored in a retrieval system, or transmitted in any form or by 
### any means without the express written consent of Cirrus Logic International
### (UK) Ltd or affiliated companies. 
###
### @file virtual_room.feature
### @brief Positional mixing simulating phase delay and attenuation as a function
###        of displacement between virtual audio and virtual microphone.
###
### @version \$Id: virtual_room.feature 1036 2015-05-11 13:49:19Z emmas $
###
### @warning
###    This software is specifically written for Cirrus Logic devices.
###    It may not be used with other devices.
###
###############################################################################
@core_regression
Feature: Test the FruitSalad step definition interface to our virtual room
         functionality.

    ###########################################################################
    #
    # We should record the output from all of these scenarios
    #
    ###########################################################################
    Background:
        Given I am recording the output


    ###########################################################################
    #
    # When microphone and source are colocated then the audio should not be
    # modified.
    #
    ###########################################################################
    Scenario: Microphone and source are colocated
        Given I am in a room with "resources/test.wav" coming from (0,0,0)
        And microphones at:
            | (0,0,0) |
        When I play the virtual room
        Then the output matches the audio file "resources/test.wav"

    ###########################################################################
    #
    # When microphone and source are seperated there should be no effect on the
    # frequency.
    #
    ###########################################################################
    Scenario: One audio source and one microphone at 1m seperation
        Given I am in a room with "resources/test.wav" coming from (1000,0,0)
        And microphones at:
            | (0,0,0) |
        When I play the virtual room
        Then the output matches the audio file "resources/test.wav"

    ###########################################################################
    #
    # By placing two microphones in a scene we should be able to mirror the audio
    # source onto both channels.
    #
    ###########################################################################
    Scenario: Two microphones each 1m from source
        Given I am in a room with "resources/test.wav" coming from (0,0,0)
        And microphones at:
            | (0,1000,0) |
            | (0,0,1000) |
        When I play the virtual room
        Then the output matches the audio file "resources/test.wav"

    ###########################################################################
    #
    # We should be able to play a sine tone in our virtual room, further we should
    # be able to detect both sine tones with our microphones.
    #
    ###########################################################################
    Scenario: 2 sources at different frequencies, with one listener
        Given I am in a room with a 1 kHz sine coming from (0,0,1000)
        And a 2000 Hz sine coming from (0,0,-1000)
        And microphones at:
            | (0,0,0) |
        When I play the virtual room for 3 seconds
        Then the output contains tones with error 5 Hz:
            | frequency |
            | 1000 Hz |
            | 2 kHz   |
        And the output does not contain tones in bands:
            | low | high |
            | 0 Hz | 995 Hz |
            | 1005 Hz | 1995 Hz |
            | 2005 Hz | 20 kHz |

    ###########################################################################
    #
    # We should be able to place a noise generator in an otherwise empty scene
    # and obtain non-silent output.
    #
    ###########################################################################
    Scenario: Noise generator colocated with microphone
        Given I am in a room with -10 dBFS noise coming from (0,0,0)
        And microphones at:
            | (0,0,0) |
        When I play the virtual room
        Then the output was not silence

    ###########################################################################
    #
    # We should be able to add a noise source into our scene; further by placing
    # that noise some distance away we should be able to trigger SC Control within
    # such a scene.
    #
    ###########################################################################
    Scenario: Soundclear Control virtual room testing
        Given I have "Ez2 Control" running on DSP3
        And use case "psia1_to_dsp3"
        And I am in a room with -20 dBFS noise coming from (3000,3000,0)
        And "resources/utterance21_bottomleft.wav" coming from (50,50,0)
        And microphones at:
            | (10,0,0) |
            | (0,10,0) |
        When I play the virtual room
        Then Ez2 Control triggers

###################################### END OF FILE ############################
