################################################################################
##
## Copyright (c) 2014 Cirrus Logic International (UK) Ltd.  All rights reserved.
##
## This software as well as any related documentation is furnished under 
## license and may only be used or copied in accordance with the terms of the 
## license. The information in this file is furnished for informational use 
## only, is subject to change without notice, and should not be construed as 
## a commitment by Cirrus Logic International (UK) Ltd.  Cirrus Logic International
## (UK) Ltd assumes no responsibility or liability for any errors or inaccuracies
## that may appear in this document or any software that may be provided in
## association with this document. 
##
## Except as permitted by such license, no part of this document may be 
## reproduced, stored in a retrieval system, or transmitted in any form or by 
## any means without the express written consent of Cirrus Logic International
## (UK) Ltd or affiliated companies.  
##
### @file frequency_response.feature
### @brief Frequency response tests
###
### @version \$Id: frequency_response.feature 556 2014-12-03 15:42:38Z piotrs $
###
### @warning
###   This software is specifically written for Cirrus Logic devices.
###   It may not be used with other devices.
###
#################################################################################
#
# Measures the frequency response of the system using audio playback.
#
#################################################################################
@manual
Feature: Frequency Response
    We should be able to measure our frequency response as being within some
    tolerance.

    ###########################################################################
    #
    # Test for run-time errors in the frequency response calculation, but do
    # nothing with the value.
    #
    ###########################################################################
    Scenario: Does the FrequencyResponse module work?
        Given I am recording the output
        When I play 1 second of white noise
        Then calculate the frequency response

    ###########################################################################
    #
    # Specify a table of bounds that the frequency response curve must pass
    # through.
    #
    ###########################################################################
    Scenario: Compare the frequency response magnitude to some tolerance
        Given I am recording the output
        When I play 1 second of white noise
        Then the frequency response gains are within:
            | frequency | gain, lower bound | gain, upper bound |
            | 50        | -8                | -5                |
            | 200       | -8                | -5                | 

    ###########################################################################
    #
    # Load a complete frequency response from a file and compare our measurement.
    #
    ###########################################################################
    Scenario: Be able to load a frequency response spec from a file
        Given I am recording the output
        When I play 1 second of white noise
        Then the frequency response matches "resources/unity.txt" within 100 dB

    ###########################################################################
    #
    # Measure and verify the frequency response of WM8946 (or dummy loopback).
    #
    # NOTE: please run this test with a sampling frequency of 44.1kHz; if you
    #       do not have an appropriate filter available you can test the
    #       response of an audio cable, to do this change the target response
    #       file to "rsp/cable_target_44_1k.rsp" (instead of
    #       "rsp/wm8946_target_44_1k.rsp")
    #
    ###########################################################################
    Scenario: Measure and verify the frequency response of WM8946 (or dummy loopback)
        Given I am recording the output
        And the sampling rate is set to 44.1 kHz
        When I measure the frequency response
        Then the frequency response matches "resources/wm8946_target_44_1k.rsp" within 1 dB for frequencies between 50 Hz and 10 kHz
########################## END OF FILE ########################################
