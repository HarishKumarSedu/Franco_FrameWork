###############################################################################
###
### Copyright (c) 2015 Cirrus Logic International (UK) Ltd.  All rights reserved.
###
### This software as well as any related documentation is furnished under 
### license and may only be used or copied in accordance with the terms of the 
### license. The information in this file is furnished for informational use 
### only, is subject to change without notice, and should not be construed as 
### a commitment by Cirrus Logic International (UK) Ltd.  Cirrus Logic International
### (UK) Ltd assumes no responsibility or liability for any errors or inaccuracies
### that may appear in this document or any software that may be provided in
### association with this document. 
###
### Except as permitted by such license, no part of this document may be 
### reproduced, stored in a retrieval system, or transmitted in any form or by 
### any means without the express written consent of Cirrus Logic International
### (UK) Ltd or affiliated companies. 
###
### @file fft_analysis.feature
### @brief Acceptance tests for FFT analysis steps.
###
### @version \$Id: fft_analysis.feature 1013 2015-04-27 14:24:00Z aangus $
###
### @warning
###    This software is specifically written for Cirrus Logic devices.
###    It may not be used with other devices.
###
###############################################################################
#
# Basic digital playback tests which check playback from various sources and
# verify recorded output.
#
#################################################################################
@core_regression
Feature: FFT Analysis
    Verifies our ability to specify advanced options to the FFT and similarity
    analysis steps.

    #############################################################################
    #
    # Background
    #
    # Describes the assumptions and context shared by all scenarios within this
    # feature.
    #
    #############################################################################
    Background:
        Given I am connected to a device

    #############################################################################
    #
    # Playback a two tone test recording (with noise) and verify that the two tones
    # are detected.
    #
    # N.B. the two tones have significantly different power levels.
    #
    #############################################################################
    Scenario: We can analyse a two tone recoding with different power levels and detect both tones.
        Given I am recording the output
        When I play the audio file "resources/two_tone_channel_test.wav"
        Then the output contains tones with error 5 Hz:
            | frequency |
            | 1000 Hz   |
            | 2 kHz     |
        And the output does not contain tones in bands:
            | low | high |
            | 0   | 995  |

    #############################################################################
    #
    # Check that FFT options are being correctly processed.
    #
    # N.B. the -12dB threshold test will fail as this will not catch the 2kHz tone.
    #
    #############################################################################
    @fruitsalad_acceptance
    Scenario: We can specify a threshold for FFT analysis - contains tones.
        Given I am recording the output
        When I play the audio file "resources/two_tone_channel_test.wav"
        Then the output contains tones with error 5 Hz and threshold -24 dB:
            | frequency |
            | 1000 Hz   |
            | 2 kHz     |
        Then the output contains tones with threshold -24 dB and error 5 Hz:
            | frequency |
            | 1000 Hz   |
            | 2 kHz     |
        Then {FAIL} the output contains tones with threshold -12 dB:
            | frequency |
            | 1000 Hz   |
            | 2 kHz     |
            
    #############################################################################
    #
    # Check that FFT options are being correctly processed.
    #
    # N.B. the -40dB threshold test will fail as it will not start to catch spurious tones in the recording.
    #
    #############################################################################
    @fruitsalad_acceptance
    Scenario: We can specify a threshold for FFT analysis - does not contain tones.
        Given I am recording the output
        When I play the audio file "resources/two_tone_channel_test.wav"
		And {FAIL} the output was silence
        And {FAIL} the output does not contain tones in bands with threshold -40 dB:
            | low | high |
            | 0   | 995  |
            
################################## END OF FILE ##################################