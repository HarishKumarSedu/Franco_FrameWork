@echo off
setlocal
rem #
rem # This script will call the batch scripts required in vivado lab tools
rem # to set up and run vivado lab for programming a target device_id
rem #
rem # Script should take in 5 positional arguments
rem #   1 -> absolute or relative path to bit file to program
rem #   2 -> device ID
rem #           This is the FPGA type as defined by the Vivado Hardware Manager
rem #           Example: for KU085 -> xcku085_1
rem #   3 -> address of platform USB cable
rem #   4 -> ID portion of the target platform USB hardware
rem #           This can typically be found in the Vivado hardware manager as part of the ID string for the USB dongle
rem #           Example: localhost/xilinx_tcf/Xilinx/00001615da2f01 // 00001615da2f01 is the hardware ID in this example
rem #   5 -> programming speed
rem #
rem # Example usage:
rem #   run_vivado_lab.bat localhost:3121 C:/validation/Projects/Lynott/e0475_05_05.bit 00001615da2f01 xcku085_1
rem #

set bit_path=%1
set device_target=%2
set address=%3
set hw_target=%4
set speed=%5

rem # Check Vivado version(Lab/HLX) installed and update VIVADO_VER accordingly
set PROG=vivado_lab
set VIVADO_ROOT=C:\Xilinx\Vivado_Lab
SET newest=not set
for /f %%a in ('dir %VIVADO_ROOT% /b /on  ^| findstr /r "^[0-9][0-9]*\.[0-9][0-9]*"') do (SET newest=%%a)
set BIN_ROOT=C:\Xilinx\Vivado_Lab\%newest%\bin
call "%BIN_ROOT%\setupEnv.bat"

rem # Set XILINX_VIVADO
set RDI_SETUP_ENV_FUNCTION=DIRNAME
call "%BIN_ROOT%/setupEnv.bat" "%BIN_ROOT%" XILINX_VIVADO
set RDI_SUPPORT_32=1

rem ##
rem # Launch the loader and specify the executable to launch
rem ##
rem #
rem # Loader arguments:
rem #   -exec   -- Name of executable to launch
rem ##
#set RDI_LABTOOLS_STANDALONE_MODE=1
call "%BIN_ROOT%/loader.bat" -exec %PROG% -mode batch -source %~dp0\program_fpga_v4.tcl -tclargs -b %bit_path% -d %device_target% -i %address% -h %hw_target% -s %speed%
@echo on