
# Function to parse command line arguments
proc parse_args {argc argv} {

  if { $argc != 4 } {
    puts "This script expects the following parameters:"
    puts "-b <path to bit file>"
	puts "-d <Device type>"
    puts "$argc"
    puts "$argv"
    exit
  } else {
    set path "./"
	set device_target ""

    foreach n [list 0 2] {
      set arg_type [lindex $argv $n]
      if {$arg_type == "-b"}  {
        set path [lindex $argv [expr {$n + 1}]]
      } elseif {$arg_type == "-d"}  {
        set device_target [lindex $argv [expr {$n + 1}]]
      }
    }
    return [list $path $device_target]
  }
  return {}
}

# Extract all the command line arguments
set params [parse_args $argc $argv]
set path [lindex $params 0]
set device [lindex $params 1]

open_hw

# A lot of this information can be found through the Vivado HW manager GUI
connect_hw_server
set fpga_targets [get_hw_targets]
puts "$fpga_targets"

for {set i 0} {$i < [llength $fpga_targets]} {incr i} {
    current_hw_target [lindex $fpga_targets $i]
    set program_freq [list_property_value PARAM.FREQUENCY [lindex $fpga_targets $i]]
    puts "Setting fastest programming freq: [lindex $program_freq [llength $program_freq]-1]"
    set_property PARAM.FREQUENCY [lindex $program_freq [llength $program_freq]-1] [lindex $fpga_targets $i]
    open_hw_target
    set fpga_devices [get_hw_devices]
    puts $fpga_devices
    for {set j 0} {$j < [llength $fpga_devices]} {incr j} {
        if {[lindex $fpga_devices $j] == $device} {
            current_hw_device [lindex $fpga_devices $j]
            refresh_hw_device -update_hw_probes false [lindex [lindex $fpga_devices $j] 0]
            set_property PROBES.FILE {} [lindex $fpga_devices $j]
            set_property FULL_PROBES.FILE {} [lindex $fpga_devices $j]
            set_property PROGRAM.FILE $path [lindex $fpga_devices $j]
            program_hw_devices [lindex $fpga_devices $j]
            break
        }
    }
    close_hw_target
}