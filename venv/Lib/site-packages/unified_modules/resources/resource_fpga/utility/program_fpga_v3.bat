@echo off
setlocal
rem #
rem # This script will call the batch scripts required in vivado lab tools
rem # to set up and run vivado lab for programming a target device_id
rem #
rem # Script should take in 4 positional arguments
rem #   1 -> address of platform USB cable
rem #   2 -> absolute or relative path to bit file to program
rem #   3 -> ID portion of the target platform USB hardware
rem #           This can typically be found in the Vivado hardware manager as part of the ID string for the USB dongle
rem #           Example: localhost/xilinx_tcf/Xilinx/00001615da2f01 // 00001615da2f01 is the hardware ID in this example
rem #   4 -> device ID
rem #           This is the FPGA type as defined by the Vivado Hardware Manager
rem #           Example: for KU085 -> xcku085_1
rem #
rem # Example usage:
rem #   run_vivado_lab.bat localhost:3121 C:/validation/Projects/Lynott/e0475_05_05.bit 00001615da2f01 xcku085_1
rem #

set address=%1
set bit_path=%2
set hw_id=%3
set device_id=%4

rem # Check Vivado version(Lab/HLX) installed and update VIVADO_VER accordingly
IF NOT EXIST "C:\Xilinx\Vivado\2019.2\bin" (
SET VIVADO_VER=Vivado_Lab)ELSE (
SET VIVADO_VER=Vivado)
set BIN_ROOT=C:\Xilinx\%VIVADO_VER%\2019.2\bin
set PROG=%VIVADO_VER%
call "%BIN_ROOT%\setupEnv.bat"

rem # Set XILINX_VIVADO
set RDI_SETUP_ENV_FUNCTION=DIRNAME
call "%BIN_ROOT%/setupEnv.bat" "%BIN_ROOT%" XILINX_VIVADO
set RDI_SUPPORT_32=1

rem ##
rem # Launch the loader and specify the executable to launch
rem ##
rem #
rem # Loader arguments:
rem #   -exec   -- Name of executable to launch
rem ##
call "%BIN_ROOT%/loader.bat" -exec %PROG% -mode batch -source %~dp0\program_fpga_v3.tcl -tclargs -i %address% -b %bit_path% -h %hw_id% -d %device_id%
@echo on